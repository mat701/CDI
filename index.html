<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>City Map Gallery</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { --accent:#1f6feb; --text:#0f172a; --bg:#f8fafc; }
    *{ box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial; }
    a { color: var(--accent); text-decoration: none; }
    .app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    header { display:flex; gap:.75rem; align-items:center; padding:.75rem 1rem; border-bottom:1px solid #e2e8f0; background:white; position: sticky; top:0; z-index:10 }
    header h1 { font-size:1.1rem; margin:0 }
    header .repo { margin-left:auto }

    /* Views */
    #view-landing, #view-city { height: 100%; }
    .landing { display:grid; grid-template-columns: 380px 1fr; height: calc(100vh - 56px); }
    .side { padding: 1rem; overflow:auto; border-right:1px solid #e2e8f0; background:white }
    .search { display:flex; gap:.5rem; margin-bottom:.75rem }
    .search input{ width:100%; padding:.55rem .7rem; border:1px solid #cbd5e1; border-radius:.55rem }
    .cities { display:grid; gap:.5rem }
    .city-card { display:flex; justify-content:space-between; align-items:center; padding:.6rem .7rem; background:#f8fafc; border:1px solid #e2e8f0; border-radius:.6rem; cursor:pointer }
    .city-card:hover { background:#eef2ff }
    .muted { color:#64748b; font-size:.85rem }

    #mapLanding, #map { width:100%; height:100% }

    .toolbar { display:flex; gap:.5rem; align-items:center; padding:.5rem 1rem; border-bottom:1px solid #e2e8f0; background:white }
    .btn { padding:.45rem .7rem; border:1px solid #cbd5e1; border-radius:.55rem; background:white; cursor:pointer }
    .btn:hover{ background:#f1f5f9 }

    .legend { background: white; padding: .5rem .6rem; border-radius: .5rem; box-shadow: 0 2px 6px rgba(0,0,0,.08); line-height: 1.1; }
    .legend .scale { display:flex; gap:2px; margin: .3rem 0 .2rem; }
    .legend .swatch { width: 18px; height: 12px; border-radius: 2px; }
    .leaflet-control-layers-expanded { max-height: 260px; overflow:auto; }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1 id="title">City Map Gallery</h1>
    <div id="subtitle" class="muted"></div>
    <a class="repo" id="repoLink" href="#" target="_blank" rel="noopener">View repo</a>
  </header>

  <!-- LANDING VIEW -->
  <div id="view-landing" class="landing">
    <div class="side">
      <div class="search">
        <input id="search" type="search" placeholder="Search cities…" />
        <button class="btn" id="clear">Clear</button>
      </div>
      <div id="cityList" class="cities"></div>
      <div class="muted" style="margin-top:.75rem">Click a city name or a map pin to open its layers.</div>
    </div>
    <div id="mapLanding"></div>
  </div>

  <!-- CITY VIEW -->
  <div id="view-city" style="display:none">
    <div class="toolbar">
      <button class="btn" id="backBtn">← Back to all cities</button>
      <div id="cityBreadcrumb" class="muted"></div>
    </div>
    <div id="map"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  // =====================
  // CONFIGURATION
  // =====================
  // Each city can define grid layers AND optional CSV joins that provide a CDI value per hexagon.
  // Join config: join: { csv: 'data/<slug>/cdi.csv', csvId: 'hexagon_id', geoId: 'hexagon_id', valueColumn: 'CDI' }
  const CITIES = [
    {
      name: 'Rome', slug: 'rome', center: [41.9028, 12.4964], zoom: 9,
      layers: [
        {
          name: 'CDI (hex grid)', url: 'data/rome/hexes.geojson',
          // If your GeoJSON features have a property like properties.hexagon_id that matches the CSV's hexagon_id:
          join: { csv: 'data/rome/cdi.csv', csvId: 'hexagon_id', geoId: 'id', valueColumn: 'CDI' }
        }
      ]
    },
    {
      name: 'Milan', slug: 'milan', center: [45.47137, 9.18905], zoom: 9,
      layers: [
        {
          name: 'CDI (hex grid)', url: 'data/milan/hexes.geojson',
          // If your GeoJSON features have a property like properties.hexagon_id that matches the CSV's hexagon_id:
          join: { csv: 'data/milan/cdi.csv', csvId: 'hexagon_id', geoId: 'id', valueColumn: 'CDI' }
        }
      ]
    },
    {
      name: 'Paris', slug: 'paris', center: [48.86368, 2.34925], zoom: 9,
      layers: [
        {
          name: 'CDI (hex grid)', url: 'data/paris/hexes.geojson',
          // If your GeoJSON features have a property like properties.hexagon_id that matches the CSV's hexagon_id:
          join: { csv: 'data/paris/cdi.csv', csvId: 'hexagon_id', geoId: 'id', valueColumn: 'CDI' }
        }
      ]
    },

    // Add more cities here…
  ];

  const REPO_URL = '#'; // set your GitHub repo URL here
  document.getElementById('repoLink').href = REPO_URL;

  // =====================
  // LANDING: list + pins
  // =====================
  const landingMap = L.map('mapLanding', { zoomControl: true }).setView([42.5, 12.5], 5);
  const baseLanding = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap & CARTO', maxZoom: 19 }).addTo(landingMap);

  const markers = [];
  CITIES.forEach(c => {
    const m = L.marker(c.center).addTo(landingMap).bindPopup(`<b>${c.name}</b><br/><a href="#/city/${c.slug}">Open map</a>`);
    m.on('click', () => goCity(c.slug));
    markers.push(m);
  });
  try {
    const group = L.featureGroup(markers);
    landingMap.fitBounds(group.getBounds().pad(0.2));
  } catch(e) {}

  const listEl = document.getElementById('cityList');
  function renderList(filter=''){
    const q = filter.trim().toLowerCase();
    listEl.innerHTML = '';
    CITIES.filter(c => !q || c.name.toLowerCase().includes(q)).forEach(c => {
      const card = document.createElement('div');
      card.className = 'city-card';
      card.innerHTML = `<div><div><strong>${c.name}</strong></div><div class=\"muted\">${c.layers.length} layer${c.layers.length>1?'s':''}</div></div><div>›</div>`;
      card.onclick = () => goCity(c.slug);
      listEl.appendChild(card);
    });
  }
  renderList();

  document.getElementById('search').addEventListener('input', (e)=> renderList(e.target.value));
  document.getElementById('clear').addEventListener('click', ()=>{ document.getElementById('search').value=''; renderList(''); });

  // =====================
  // COLOR SCALES
  // =====================
  function fmt(v){ return Number.isFinite(v) ? new Intl.NumberFormat().format(v) : 'n/a'; }

  // Diverging blue-white-red for CDI in [-1,1]
  function cdiColor(v){
    if (!Number.isFinite(v)) return '#cccccc';
    const t = Math.max(-1, Math.min(1, v)); // clamp
    // Colors: blue #2166ac -> white #ffffff -> red #b2182b
    const blue = [0x21,0x66,0xac], white=[0xff,0xff,0xff], red=[0xb2,0x18,0x2b];
    function lerp(a,b,t){ return a + (b-a)*t; }
    let rgb;
    if (t < 0){ // blue -> white
      const u = (t + 1) / 1; // [-1,0] -> [0,1]
      rgb = [lerp(blue[0], white[0], u), lerp(blue[1], white[1], u), lerp(blue[2], white[2], u)];
    } else { // white -> red
      const u = t / 1; // [0,1] -> [0,1]
      rgb = [lerp(white[0], red[0], u), lerp(white[1], red[1], u), lerp(white[2], red[2], u)];
    }
    return '#' + rgb.map(v=> Math.round(v).toString(16).padStart(2,'0')).join('');
  }

  function makeQuantileScale(values, n = 7) {
    const sorted = values.filter(v => Number.isFinite(v)).sort((a,b) => a-b);
    if (!sorted.length) return v => '#cccccc';
    const qs = Array.from({length:n+1}, (_,i)=> sorted[Math.min(sorted.length-1, Math.floor(i*(sorted.length-1)/n))]);
    const palette = ['#f1eef6','#d4b9da','#c994c7','#df65b0','#e7298a','#ce1256','#91003f'];
    return function(v){ if (!Number.isFinite(v)) return '#cccccc'; for (let i=0;i<n;i++) if (v <= qs[i+1]) return palette[i]; return palette[n-1]; };
  }

  // =====================
  // LEGEND CONTROL
  // =====================
  const Legend = L.Control.extend({
    options: { position: 'bottomright' },
    onAdd: function(){ const d = L.DomUtil.create('div','legend'); d.innerHTML = '<b>Legend</b><div class="scale" id="legend-scale"></div><div class="muted" id="legend-note"></div>'; this._div=d; return d; },
    updateSwatches: function(colors, labels){
      const scale=this._div.querySelector('#legend-scale');
      scale.innerHTML='';
      for(let i=0;i<colors.length;i++){
        const sw=document.createElement('div'); sw.className='swatch'; sw.style.background=colors[i]; sw.title=labels && labels[i] ? labels[i] : '';
        scale.appendChild(sw);
      }
      this._div.querySelector('#legend-note').textContent = '';
    },
    note: function(text){ this._div.querySelector('#legend-note').textContent = text || ''; }
  });

  // =====================
  // CSV LOADER / JOIN
  // =====================
  async function loadCsvMap(url, keyCol, valueCol){
    const res = await fetch(url);
    if (!res.ok) throw new Error('Failed to load CSV '+url);
    const text = await res.text();
    const parsed = Papa.parse(text, { header:true, dynamicTyping:true, skipEmptyLines:true });
    const map = new Map();
    parsed.data.forEach(r => {
      const k = r[keyCol];
      const v = r[valueCol];
      if (k !== undefined) map.set(String(k), v);
    });
    return map;
  }

  // =====================
  // CITY VIEW (reuses Leaflet)
  // =====================
  let cityMap, layerControl, legend;

  async function loadCity(slug){
    const city = CITIES.find(c => c.slug === slug);
    if (!city) return goHome();

    // swap views
    document.getElementById('view-landing').style.display='grid'; // keep layout while we prep
    document.getElementById('view-city').style.display='block';
    document.getElementById('view-landing').style.display='none';
    document.getElementById('subtitle').textContent = city.name;
    document.getElementById('cityBreadcrumb').textContent = city.name;

    if (!cityMap){
      cityMap = L.map('map', { zoomControl:true });
      const base = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap & CARTO', maxZoom:19 }).addTo(cityMap);
      layerControl = L.control.layers({ 'Light': base }, {}, { collapsed:false }).addTo(cityMap);
      legend = new Legend(); legend.addTo(cityMap);
    }

    cityMap.setView(city.center, city.zoom || 12);

    // remove existing overlays from control
    const toRemove = [];
    cityMap.eachLayer(l => { /* keep base */ });
    if (layerControl && layerControl._layers){
      Object.values(layerControl._layers).forEach(obj => { if (obj.overlay) toRemove.push(obj.layer); });
      toRemove.forEach(l => { try{ cityMap.removeLayer(l); }catch(e){} });
    }

    const overlayGroups = {};

    for (const def of city.layers){
      try {
        const res = await fetch(def.url);
        if (!res.ok) throw new Error('failed '+def.url);
        const gj = await res.json();

        // Optional CSV join for CDI
        let joinMap = null, csvId, geoId, valueCol;
        if (def.join){
          csvId = def.join.csvId || 'hexagon_id';
          geoId = def.join.geoId || 'id';
          valueCol = def.join.valueColumn || 'CDI';
          joinMap = await loadCsvMap(def.join.csv, csvId, valueCol);
          // annotate features with CDI
          (gj.features||[]).forEach(f => {
            const k = f.properties?.[geoId];
            if (k !== undefined){
              const v = joinMap.get(String(k));
              if (v !== undefined) f.properties[valueCol] = v;
            }
          });
        }

        // Determine color function
        let styleColor, legendColors, legendLabels, legendNote;
        if (def.join){
          styleColor = f => cdiColor(Number(f.properties?.[valueCol]));
          // Build a simple diverging legend with 9 swatches from -1 .. 1
          const steps = 9;
          legendColors = Array.from({length:steps}, (_,i)=> cdiColor((i/(steps-1))*2-1));
          legendLabels = ['-1 … 1 scale'];
          legendNote = `${valueCol}: -1 (blue) → 0 (white) → 1 (red)`;
        } else {
          // fallback quantiles by def.valueProp
          const vals=[]; (gj.features||[]).forEach(f=>{ const v=Number(f.properties?.[def.valueProp]); if(Number.isFinite(v)) vals.push(v); });
          const color = makeQuantileScale(vals, 7);
          styleColor = f => color(Number(f.properties?.[def.valueProp]));
          legendColors = ['#f1eef6','#d4b9da','#c994c7','#df65b0','#e7298a','#ce1256','#91003f'];
          legendNote = def.valueProp || '';
        }

        const layer = L.geoJSON(gj, {
          style: f => ({ color:'#333', weight:0.6, fillOpacity:0.85, fillColor: styleColor(f) }),
          onEachFeature:(feature, lyr)=>{
            const p=feature.properties||{};
            const cdi = def.join ? Number(p[valueCol]) : undefined;
            const showVal = def.join ? `${valueCol}: <b>${Number.isFinite(cdi)? cdi.toFixed(3):'n/a'}</b>` : `${def.valueProp}: <b>${fmt(Number(p[def.valueProp]))}</b>`;
            const keys=Object.keys(p).filter(k=>!['uid','id'].includes(k));
            const rows=keys.map(k=>`<tr><td><strong>${k}</strong></td><td>${p[k]}</td></tr>`).join('');
            lyr.bindPopup(`<div><b>${def.name}</b><br/>${showVal}<table>${rows}</table></div>`);
          }
        }).addTo(cityMap);

        overlayGroups[def.name]=layer;
        layerControl.addOverlay(layer, def.name);
        // Update legend when toggled
        layer.on('add', ()=> { legend.updateSwatches(legendColors); legend.note(legendNote); });
      } catch(e){ console.error(e); }
    }

    // fit to first overlay
    const names = Object.keys(overlayGroups);
    if (names.length){ try{ cityMap.fitBounds(overlayGroups[names[0]].getBounds(), { padding:[20,20] }); }catch(e){} }
  }

  function goCity(slug){ location.hash = `#/city/${slug}`; }
  function goHome(){ location.hash = '#/'; }

  document.getElementById('backBtn').addEventListener('click', goHome);

  // simple hash router
  function router(){
    const hash = location.hash || '#/';
    if (hash.startsWith('#/city/')){
      const slug = hash.split('/')[2];
      document.getElementById('title').textContent = 'City • ' + slug;
      loadCity(slug);
    } else {
      document.getElementById('title').textContent = 'City Map Gallery';
      document.getElementById('subtitle').textContent = '';
      document.getElementById('view-landing').style.display='grid';
      document.getElementById('view-city').style.display='none';
    }
  }
  window.addEventListener('hashchange', router);
  router();
</script>
</body>
</html>